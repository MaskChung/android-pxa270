pid=$$

t=1
export t

# Warm up
beg=`ps -o pid,vsz | grep "^ *$pid "`
i=1
while test $i != X; do
    t=111111111111111111111111111111111111111111111111111111111111111111111110$i
    t=111111111111111111111111111111111111111111111111111111111111111111111111$i true
    t=111111111111111111111111111111111111111111111111111111111111111111111112$i /bin/true
    t=111111111111111111111111111111111111111111111111111111111111111111111113$i exec 1>&1
    i=1$i
    if test $i = 1111111111111111111111111111111111111111111111; then i=2; fi
    if test $i = 1111111111111111111111111111111111111111111112; then i=3; fi
    if test $i = 1111111111111111111111111111111111111111111113; then i=4; fi
    if test $i = 1111111111111111111111111111111111111111111114; then i=X; fi
done
end=`ps -o pid,vsz | grep "^ *$pid "`

# Warm up again (I do need it on my machine)
beg=`ps -o pid,vsz | grep "^ *$pid "`
i=1
while test $i != X; do
    t=111111111111111111111111111111111111111111111111111111111111111111111110$i
    t=111111111111111111111111111111111111111111111111111111111111111111111111$i true
    t=111111111111111111111111111111111111111111111111111111111111111111111112$i /bin/true
    t=111111111111111111111111111111111111111111111111111111111111111111111113$i exec 1>&1
    i=1$i
    if test $i = 1111111111111111111111111111111111111111111111; then i=2; fi
    if test $i = 1111111111111111111111111111111111111111111112; then i=3; fi
    if test $i = 1111111111111111111111111111111111111111111113; then i=4; fi
    if test $i = 1111111111111111111111111111111111111111111114; then i=X; fi
done
end=`ps -o pid,vsz | grep "^ *$pid "`
if test "$beg" != "$end"; then
    true echo "vsz grows: $beg -> $end"
else
    true echo "vsz does not grow"
fi

echo "Measuring memory leak..."
beg=`ps -o pid,vsz | grep "^ *$pid "`
i=1
while test $i != X; do
    t=111111111111111111111111111111111111111111111111111111111111111111111110$i
    t=111111111111111111111111111111111111111111111111111111111111111111111111$i true
    t=111111111111111111111111111111111111111111111111111111111111111111111112$i /bin/true
    t=111111111111111111111111111111111111111111111111111111111111111111111113$i exec 1>&1
    i=1$i
    if test $i = 1111111111111111111111111111111111111111111111; then i=2; fi
    if test $i = 1111111111111111111111111111111111111111111112; then i=3; fi
    if test $i = 1111111111111111111111111111111111111111111113; then i=4; fi
    if test $i = 1111111111111111111111111111111111111111111114; then i=X; fi
done
end=`ps -o pid,vsz | grep "^ *$pid "`

if test "$beg" != "$end"; then
    echo "vsz grows: $beg -> $end"
else
    echo "vsz does not grow"
fi
